name: Deploy Frontend to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify deployment files
      run: |
        echo "Files to be deployed:"
        ls -la
        echo "Docker compose file:"
        cat docker-compose.yml

    - name: Copy files with SSH
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        ARGS: "-rlgoDzvc -i"
        SOURCE: "./"
        REMOTE_HOST: ${{ secrets.EC2_HOST }}
        REMOTE_USER: ${{ secrets.EC2_SSH_USER }}
        TARGET: '/home/${{ secrets.EC2_SSH_USER }}/salao-frontend'
        EXCLUDE: "/dist/, /node_modules/, /.git/, /coverage/, /.vscode/, /.idea/"
        SCRIPT_AFTER: |
          # Build and start the frontend services
          cd /home/${{ secrets.EC2_SSH_USER }}/salao-frontend

          echo "Cleaning up unused Docker resources..."
          sudo docker system prune --volumes -f

          # echo "Stopping existing containers..."
          # sudo docker-compose down || true

          echo "Building and starting frontend containers with API URL..."
          sudo REACT_APP_API_BASE_URL=http://ec2-3-131-171-43.us-east-2.compute.amazonaws.com:8000 docker-compose up -d --build

          echo "Waiting for containers to start..."
          sleep 10

          # Health check
          echo "Performing health check..."
          if curl -f ec2-3-131-171-43.us-east-2.compute.amazonaws.com:80 > /dev/null 2>&1; then
            echo "âœ… Frontend deployment successful! Application is responding."
          else
            echo "âŒ Health check failed. Checking container logs..."
            sudo docker-compose logs
            exit 1
          fi

          echo "ğŸš€ Frontend deployment completed successfully!"
